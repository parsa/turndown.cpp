name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build-gumbo:
    name: Build (Gumbo, ${{ matrix.build_type }})
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgumbo-dev libgtest-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DTURNDOWN_BUILD_DOCS=OFF -DTURNDOWN_PARSER_BACKEND=gumbo

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Test
        working-directory: build
        run: ctest --build-config ${{ matrix.build_type }} --output-on-failure

  build-tidy:
    name: Build (Tidy, ${{ matrix.build_type }})
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libtidy-dev libgtest-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DTURNDOWN_BUILD_DOCS=OFF -DTURNDOWN_PARSER_BACKEND=tidy

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Test (allow failures)
        working-directory: build
        # Tidy backend has some known test differences; run tests but don't fail the build
        run: ctest --build-config ${{ matrix.build_type }} --output-on-failure || echo "::warning::Some tests failed with tidy backend (expected)"

  build-lexbor:
    name: Build (Lexbor, ${{ matrix.build_type }})
    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, Release]

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          # Add lexbor repository (https://lexbor.com/download/#ubuntu)
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://lexbor.com/keys/lexbor_signing.key | sudo gpg --dearmor -o /etc/apt/keyrings/lexbor.gpg
          echo "deb [signed-by=/etc/apt/keyrings/lexbor.gpg] https://packages.lexbor.com/ubuntu/ $(lsb_release -cs) liblexbor" | sudo tee /etc/apt/sources.list.d/lexbor.list
          sudo apt-get update
          sudo apt-get install -y libgtest-dev liblexbor liblexbor-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} -DTURNDOWN_BUILD_DOCS=OFF -DTURNDOWN_PARSER_BACKEND=lexbor

      - name: Build
        run: cmake --build build --config ${{ matrix.build_type }}

      - name: Test
        working-directory: build
        run: ctest --build-config ${{ matrix.build_type }} --output-on-failure

  install-test:
    name: Install Test (Gumbo)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y libgumbo-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DTURNDOWN_BUILD_DOCS=OFF -DTURNDOWN_BUILD_TESTING=OFF -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/build/install_prefix -DTURNDOWN_PARSER_BACKEND=gumbo

      - name: Build
        run: cmake --build build

      - name: Install
        run: cmake --install build

      - name: Configure Install Test
        run: cmake -B build/install_test -S test/install_test -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=${{ github.workspace }}/build/install_prefix

      - name: Build Install Test
        run: cmake --build build/install_test

      - name: Run Install Test
        run: ./build/install_test/install_test
